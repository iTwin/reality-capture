<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Service.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Service.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RealityDataAnalysisService = void 0;
const service_authorization_1 = require("@itwin/service-authorization");
const Settings_1 = require("./Settings");
const Utils_1 = require("./Utils");
const node_fetch_1 = require("node-fetch");
/**
 * Service handling communication with RealityData Analysis Service
 */
class RealityDataAnalysisService {
    /**
     * Create a new RealityDataAnalysisService from provided iModel application.
     * @param {string} serviceUrl Url of the RealityData Analysis Service.
     * @param {string} clientId A client id with realitydata and realitydataanalysis scopes.
     * @param {string} secret Service application secret.
     */
    constructor(serviceUrl, clientId, secret) {
        this.serviceUrl = serviceUrl;
        this.authorizationClient = new service_authorization_1.ServiceAuthorizationClient({
            clientId: clientId,
            clientSecret: secret,
            scope: "realitydata:modify realitydata:read realitydataanalysis:read realitydataanalysis:modify",
            authority: "https://qa-ims.bentley.com",
        });
    }
    /**
     * @private
     * @param {string} url API url.
     * @param {string} method HTTP method.
     * @param {number[]} okRet HTTP expected code.
     * @param {unknown|undefined} payload request body.
     * @returns {any} request response.
     */
    async submitRequest(url, method, okRet, payload = undefined) {
        const headers = {
            "Content-Type": "application/json",
            "Accept": "application/vnd.bentley.v1+json",
            "Authorization": await this.authorizationClient.getAccessToken(),
        };
        const reqBase = {
            headers,
            method
        };
        const request = ["POST", "PATCH"].includes(method) ? { ...reqBase, body: JSON.stringify(payload) } : reqBase;
        const response = await (0, node_fetch_1.default)(url, request);
        if (!okRet.includes(response.status))
            return Error("Fail : request: " + response.url + ", return code : " + response.status + " " + response.statusText);
        const res = await response.json();
        return res;
    }
    /**
     * Create a job corresponding to the given settings.
     * @param {JobSettings} settings Settings for the job.
     * @param {string} jobName Name for the job.
     * @param {string} iTwinId iTwin associated to this job.
     * @returns {string | Error} Created job id, or a potential error message.
     */
    async createJob(settings, jobName, iTwinId) {
        const body = {
            "type": settings.type,
            "name": jobName,
            "iTwinId": iTwinId,
            "settings": settings.toJson()
        };
        const response = await this.submitRequest(this.serviceUrl + "jobs", "POST", [201], body);
        if ("message" in response)
            return response;
        return response["job"]["id"];
    }
    /**
     * Submit a job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {void | Error} A potential error message.
     */
    async submitJob(jobId) {
        const body = { "state": "active" };
        const response = await this.submitRequest(this.serviceUrl + "jobs/" + jobId, "PATCH", [200], body);
        if ("message" in response)
            return response;
    }
    /**
     * Cancel a job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {void | Error} A potential error message.
     */
    async cancelJob(jobId) {
        const body = {
            "state": "cancelled",
        };
        const response = await this.submitRequest(this.serviceUrl + "jobs/" + jobId, "PATCH", [200], body);
        if ("message" in response)
            return response;
    }
    /**
     * Delete a job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {void | Error} A potential error message.
     */
    async deleteJob(jobId) {
        const response = await this.submitRequest(this.serviceUrl + "jobs/" + jobId, "DELETE", [204]);
        if ("message" in response)
            return response;
    }
    /**
     * Get progress for a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {JobProgress | Error} The progress for the job, or a potential error message.
     */
    async getJobProgress(jobId) {
        const response = await this.submitRequest(this.serviceUrl + `jobs/${jobId}/progress`, "GET", [200]);
        const progress = response["progress"];
        if ("message" in response)
            return response;
        return { status: progress["state"], progress: JSON.parse(progress["percentage"]), step: progress["step"] };
    }
    /**
     * Get settings for a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {O2DJobSettings | Error} The settings for the job, or a potential error message.
     */
    async getO2DJobSettings(jobId) {
        const response = await this.submitRequest(this.serviceUrl + "jobs/" + jobId, "GET", [200]);
        if ("message" in response)
            return response;
        return Settings_1.O2DJobSettings.fromJson(response["job"]["settings"]);
    }
    /**
     * Get settings for a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {O3DJobSettings | Error} The settings for the job, or a potential error message.
     */
    async getO3DJobSettings(jobId) {
        const response = await this.submitRequest(this.serviceUrl + "jobs/" + jobId, "GET", [200]);
        if ("message" in response)
            return response;
        return Settings_1.O3DJobSettings.fromJson(response["job"]["settings"]);
    }
    /**
     * Get settings for a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {S2DJobSettings | Error} The settings for the job, or a potential error message.
     */
    async getS2DJobSettings(jobId) {
        const response = await this.submitRequest(this.serviceUrl + "jobs/" + jobId, "GET", [200]);
        if ("message" in response)
            return response;
        return Settings_1.S2DJobSettings.fromJson(response["job"]["settings"]);
    }
    /**
     * Get settings for a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {S3DJobSettings | Error} The settings for the job, or a potential error message.
     */
    async getS3DJobSettings(jobId) {
        const response = await this.submitRequest(this.serviceUrl + "jobs/" + jobId, "GET", [200]);
        if ("message" in response)
            return response;
        return Settings_1.S3DJobSettings.fromJson(response["job"]["settings"]);
    }
    /**
     * Get settings for a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {L3DJobSettings | Error} The settings for the job, or a potential error message.
     */
    async getL3DJobSettings(jobId) {
        const response = await this.submitRequest(this.serviceUrl + "jobs/" + jobId, "GET", [200]);
        if ("message" in response)
            return response;
        return Settings_1.L3DJobSettings.fromJson(response["job"]["settings"]);
    }
    /**
     * Get settings for a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {ChangeDetectionJobSettings | Error} The settings for the job, or a potential error message.
     */
    async getChangeDetectionJobSettings(jobId) {
        const response = await this.submitRequest(this.serviceUrl + "jobs/" + jobId, "GET", [200]);
        if ("message" in response)
            return response;
        return Settings_1.ChangeDetectionJobSettings.fromJson(response["job"]["settings"]);
    }
    /**
     * Get settings for a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {JobSettings | Error} The settings for the job, or a potential error message.
     */
    async getJobSettings(jobId) {
        const response = await this.submitRequest(this.serviceUrl + "jobs/" + jobId, "GET", [200]);
        if ("message" in response)
            return response;
        if (response["job"]["type"] === Utils_1.RDAJobType.O2D)
            return Settings_1.O2DJobSettings.fromJson(response["job"]["settings"]);
        if (response["job"]["type"] === Utils_1.RDAJobType.S2D)
            return Settings_1.S2DJobSettings.fromJson(response["job"]["settings"]);
        if (response["job"]["type"] === Utils_1.RDAJobType.O3D)
            return Settings_1.O3DJobSettings.fromJson(response["job"]["settings"]);
        if (response["job"]["type"] === Utils_1.RDAJobType.S3D)
            return Settings_1.S3DJobSettings.fromJson(response["job"]["settings"]);
        if (response["job"]["type"] === Utils_1.RDAJobType.L3D)
            return Settings_1.L3DJobSettings.fromJson(response["job"]["settings"]);
        if (response["job"]["type"] === Utils_1.RDAJobType.ChangeDetection)
            return Settings_1.ChangeDetectionJobSettings.fromJson(response["job"]["settings"]);
        return Error("Can't get job settings of unknown type : " + response["job"]["type"]);
    }
    /**
     * Get all properties for a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {RDAJobProperties | Error} The job properties, or a potential error message.
     */
    async getJobProperties(jobId) {
        const response = await this.submitRequest(this.serviceUrl + "jobs/" + jobId, "GET", [200]);
        if ("message" in response)
            return response;
        const job = response["job"];
        console.log("json : ", job);
        const jobProperties = {
            name: job["name"],
            type: job["type"],
            iTwinId: job["iTwinId"],
            settings: new Settings_1.O2DJobSettings(),
            id: job["id"],
            email: job["email"],
            state: job["state"],
            createdDateTime: job["createdDateTime"],
            lastModifiedDataTime: job["lastModifiedDataTime"],
            dataCenter: job["dataCenter"],
        };
        let settings;
        if (job["type"] === Utils_1.RDAJobType.O2D) {
            console.log("O2D settings");
            settings = Settings_1.O2DJobSettings.fromJson(job["settings"]);
        }
        else if (job["type"] === Utils_1.RDAJobType.S2D) {
            settings = Settings_1.S2DJobSettings.fromJson(job["settings"]);
        }
        else if (job["type"] === Utils_1.RDAJobType.O3D) {
            settings = Settings_1.O3DJobSettings.fromJson(job["settings"]);
        }
        else if (job["type"] === Utils_1.RDAJobType.S3D) {
            settings = Settings_1.S3DJobSettings.fromJson(job["settings"]);
        }
        else if (job["type"] === Utils_1.RDAJobType.L3D) {
            settings = Settings_1.L3DJobSettings.fromJson(job["settings"]);
        }
        else if (job["type"] === Utils_1.RDAJobType.ChangeDetection) {
            settings = Settings_1.ChangeDetectionJobSettings.fromJson(job["settings"]);
        }
        else
            return Error("Can't get job properties of unknown type : " + job["type"]);
        if (settings instanceof Error)
            return settings;
        jobProperties.settings = settings;
        if (job["executionInformation"]) {
            jobProperties.executionInformation = {
                exitCode: job["executionInformation"]["exitCode"],
                submissionDateTime: job["executionInformation"]["submissionDateTime"],
                startedDateTime: job["executionInformation"]["startedDateTime"],
                endedDateTime: job["executionInformation"]["endedDateTime"],
                estimatedUnits: job["executionInformation"]["estimatedUnits"],
            };
        }
        if (job["costEstimation"]) {
            jobProperties.costEstimation = {
                gigaPixels: job["costEstimation"]["gigaPixels"],
                numberOfPhotos: job["costEstimation"]["numberOfPhoto"],
                sceneWidth: job["costEstimation"]["sceneWidth"],
                sceneHeight: job["costEstimation"]["sceneHeight"],
                sceneLength: job["costEstimation"]["sceneLength"],
                detectorScale: job["costEstimation"]["detectorScale"],
                detectorCost: job["costEstimation"]["detectorCost"],
                estimateCost: job["costEstimation"]["estimateCost"],
            };
        }
        return jobProperties;
    }
    /**
     * Get type of a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {RDAJobType | Error} The type for the job, or a potential error message.
     */
    async getJobType(jobId) {
        const properties = await this.getJobProperties(jobId);
        if ("message" in properties)
            return properties;
        return properties.type;
    }
    /**
     * Get iTwinId of a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {string | Error} The job iTwinId, or a potential error message.
     */
    async getJobiTwinId(jobId) {
        const properties = await this.getJobProperties(jobId);
        if ("message" in properties)
            return properties;
        return properties.iTwinId;
    }
    /**
     * Get name of a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {string | Error} The job name, or a potential error message.
     */
    async getJobName(jobId) {
        const properties = await this.getJobProperties(jobId);
        if ("message" in properties)
            return properties;
        return properties.name;
    }
    /**
     * Get execution information of a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {ExecutionInformation | undefined | Error} The job execution information, or a potential error message.
     */
    async getJobExecutionInformation(jobId) {
        const properties = await this.getJobProperties(jobId);
        if ("message" in properties)
            return properties;
        return properties.executionInformation;
    }
    /**
     * Get the estimated cost of a given job.
     * @param {string} jobId The ID of the relevant job.
     * @returns {number | undefined | Error} The job cost estimation, or a potential error message.
     */
    async getJobEstimatedCost(jobId, costParameters) {
        var _a;
        const body = {
            costEstimationParameters: {
                gigaPixels: costParameters.gigaPixels,
                numberOfPhotos: costParameters.numberOfPhotos,
                sceneWidth: costParameters.sceneWidth,
                sceneHeight: costParameters.sceneHeight,
                sceneLength: costParameters.sceneLength,
                detectorScale: costParameters.detectorScale,
                detectorCost: costParameters.detectorCost,
            }
        };
        const response = await this.submitRequest(this.serviceUrl + "jobs/" + jobId, "PATCH", [200], body);
        if ("message" in response)
            return response;
        return (_a = response.costEstimation) === null || _a === void 0 ? void 0 : _a.estimateCost;
    }
}
exports.RealityDataAnalysisService = RealityDataAnalysisService;
//# sourceMappingURL=Service.js.map</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="RealityDataAnalysisService.html">RealityDataAnalysisService</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Tue Oct 18 2022 15:17:32 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
