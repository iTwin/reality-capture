name: Publish Python SDK

on: workflow_dispatch

jobs:
  build_and_publish_sdk:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"

    - name: Create virtual env
      working-directory: .\python_sdk
      run: |
        python -m venv venv

    - name: Build wheel
      working-directory: .\python_sdk
      run: |
        .\venv\Scripts\activate
        python -m pip install build
        python -m build

    - name: Find Wheel File
      id: find_wheel
      working-directory: .\python_sdk
      run: |
        $wheel = Get-ChildItem dist\*.whl | Select-Object -First 1
        Write-Host "Wheel Full Name: $($wheel.FullName)"
        Write-Host "Wheel Name: $($wheel.Name)"
        echo "wheel_full_name=$($wheel.FullName)" >> "$GITHUB_OUTPUT"
        echo "wheel_name=$($wheel.Name)" >> "$GITHUB_OUTPUT"
      shell: pwsh

    - name: Install documentation dependencies
      working-directory: .\python_sdk
      run: |
        .\venv\Scripts\Activate.ps1
        Write-Host "Wheel location: ${{ steps.find_wheel.outputs.wheel_full_name }}"
        python -m pip install ${{ steps.find_wheel.outputs.wheel_full_name }}
        python -m pip freeze
        Write-Host "Installing dev dependencies..."
        python -m pip install .[dev]
        python -m pip freeze
      shell: pwsh

    - name: Build documentation
      working-directory: .\python_sdk\docs
      shell: pwsh
      run: |
        ..\venv\Scripts\Activate.ps1
        python -m pip freeze
        & .\make.bat html

    - name: Create Pre-Release
      uses: actions/create-release@v1
      id: create_pre_release
      with:
        tag_name: 2.0.0-alpha.1
        release_name: "Version 2.0.0-alpha.1"
        draft: true
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload wheel
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_pre_release.outputs.upload_url }}
        asset_path: ${{ steps.find_wheel.outputs.wheel_full_name }}
        asset_name: ${{ steps.find_wheel.outputs.wheel_name }}
        asset_content_type: application/octet-stream
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Reformat doc
      working-directory: .\python_sdk\docs
      run: |
        New-Item -Path ".\User Guide\en" -ItemType Directory -Force
        Copy-Item -Path .\_build\html -Destination ".\User Guide\en\html5" -Recurse
        Compress-Archive -Path ".\User Guide" -DestinationPath .\Documentation.zip
      shell: pwsh

    - name: Upload doc
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_pre_release.outputs.upload_url }}
        asset_path: .\python_sdk\docs\Documentation.zip
        asset_name: Documentation.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
